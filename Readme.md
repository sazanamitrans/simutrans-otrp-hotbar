
Simutrans Hotbar Patch (based on OTRP v32.1)
============================================

1. [機能](#機能)
2. [ダウンロード/導入方法](#ダウンロード導入方法)
3. [設定方法](#設定方法)
4. [ビルド方法](#ビルド方法)

機能
===========
[Simutrans OTRP v32.1](https://github.com/teamhimeh/simutrans/blob/OTRP-distribute/documentation/OTRP_v13_information.md)に以下の機能を追加しました。

ホットバーの追加
---------------
 - 画面下部にホットバー表示領域を追加します。
 - ホットバーへの登録は、ツールを選択[^1]したあと、
   - ホットバーの空いているスロットをクリック。
   - またはCTRL + 数字キーを押す。(空いていないスロットの場合は上書きします。)
 - 登録したツールの使用は、ホットバーを再度クリックするか、対応するキー(数字キー) を押します。
 - ホットバーの解除は、スロットを右クリックします。
 - ALT + 数字キーを押すことで、キーボードで操作できるアクティブなホットバーを選択できます。
   - 表示されていないホットバー(初期状態ではホットバー5 ～10) があります。 表示されていないホットバーを選択すると、現在アクティブなホットバーと入れ替えます。
 - ホットバーを保存する機能はまだありません。再起動のたびにリセットされます。

修飾キーの追加 / キー指定方法の変更
-----------------------------------
 - ALTキーを含む組み合わせをキーボードショートカットとして登録できます。
 - キーボードショートカットを修飾キーとキー名の組み合わせで指定するようにしました。このため`menuconf.tab`の置き換えまたは再設定が必要です。
 - 無効なキーを入力した場合でも、キーボードヘルプが表示されないようにしました。
   - ヘルプの表示には、SHIFT + / もしくはF1キーを押してください。

スクリプトの中断/再開/再起動
----------------------------
 - 本パッチのないバージョンでは、`description.tab` に`restart=0` を記載しているのにもかかわらず、ツールを選びなおすたびにスクリプトの状態がリセットされていました。本パッチでは、`restart=0` を指定すると前回の変数などの状態を保持したまま`init()` が呼ばれます。
 - CTRL キーを押しながらスクリプトツールを選択すると、スクリプトの状態をリセットして再起動します。
 - ツールバーからスクリプトツールを再起動した場合、ホットバーに登録されたスクリプトツールは再起動されず、ホットバーのスクリプトツールを選択することで再起動以前の状態にアクセスできます[^2][^3]。 そのため、いろいろな状態のスクリプトツールをホットバーに保存しておくことができます。
 - ホットバーに保存したスクリプトツールの状態は、ホットバーのスロットからツールを削除または上書きすると、自動的に終了処理が行われメモリが解放されます。[^4]

ダウンロード / 導入方法
=======================
  1. exe をダウンロードする(Windows 版しかありません。)
  2. Simutrans をインストールしているフォルダ(もしくはそれをコピーしたフォルダ)にexeを置く。
  3. OTRP 版の導入が初めてなら一方通行表示用のpak をインストールする。(https://osdn.net/projects/otrp/downloads/76098/RibiArrow.zip)
  4. 🔴 **menuconf.tab を置き換える、もしくは設定する(重要！）** 🔴
    - **pak128(.Japan) 標準ツールバーやAHNS ツールバーを利用している場合** `(インストールフォルダー)/(pakセット)/config/menuconf.tab` を `config/pak128-toolbar/menuconf.tab`, `config/AHNS-toolbar/menuconf.tab` で置き換える。(置き換え前のファイルのバックアップを取っておくことを推奨します。)
    - **その他のツールバーを利用している場合、menuconf.tabを自分でカスタマイズしている場合、日本語キーボード以外のキーボードを利用している場合** `menuconf.tab` を編集してください。
  5. セーブデータの形式はOTRP v30.1 と同一（なはず）です。念のためバックアップ(ry

menuconf.tab 編集方法
---------------------
`(インストールフォルダー)/(pakセット)/config/menuconf.tab` をメモ帳で開き、キーボードショートカットを指定しているとおぼしき文字(列) を次のように置き換えてください。

|変更前   |   変更後   |                                      | 
|---------|------------|--------------------------------------|
| `a`     | `A`        | アルファベットは大文字にしてください |
| `S`     | `SHIFT S`  | SHIFT キーは明示的に指定してください |
| `^p`    | `CTRL P`   | `^`で始まる文字列はCTRLキーを表す    |
| `+`     | `SHIFT ;`  | 入力にSHIFT キーが必要な記号類は、入力方法を指定してください。|
| `COMMA` | `COMMA`    | COMMA やEND, HOME などの特殊キーはそのままです。 |

ただし、以下の行は紛らわしいので注意してください。
```INI
toolbar[0][33]=simple_tool[15],29,^U,K
toolbar[0][34]=simple_tool[15],,END,I
toolbar[0][35]=simple_tool[15],,HOME,D
```
ここの最後のK, I, Dはキーボードショートカットではなく、ヘイトカットレベルをの上下を変更するためのパラメータなので、SHIFT Kなどと書き換えないでください。

```INI
toolbar[0][33]=simple_tool[15],29,CTRL SHIFT U,K
toolbar[0][34]=simple_tool[15],,END,I
toolbar[0][35]=simple_tool[15],,HOME,D
```

設定方法
========
ホットバーの設定
----------------
ホットバーのキーボードショートカットや表示方法を変更したい場合は、
`(Simutrans ユーザーディレクトリ)/hotbar.tab` を設定してください。

```INI
# ホットバー１本あたりのスロットの数を変更する(デフォルト: 10)
n_slots=16
# 表示するホットバーの数を変更する(デフォルト: 4)
n_visible_hotbars=6
# ホットバーを縦に表示する(デフォルト: 0 [横に表示する])
vertical=1
# ホットバーを横に並べる数を変更する(デフォルト: 2)
n_hotbars_per_row=3

# スロット選択のキーボードショートカットを変更する(デフォルト: 1234567890)
# アルファベットは大文字で指定
slot_keys=QWERTYUIOP
# ホットバー選択のキーボードショートカットを変更する(デフォルト: 1234567890)
hotbar_keys=ASDFJKL;
# キーボードでホットバー選択時に自動で最初のスロットのツールを選択する(デフォルト: 0 [無効])
auto_select_tool=1
# スロット選択時に必要な修飾キーを設定する(デフォルト: (なし) [不要])
get_modifier=SHIFT
# スロット設定時に必要な修飾キーを設定する(デフォルト: CTRL)
set_modifier=SHIFT CTRL
# ホットバー選択時に必要な修飾キーを設定する(デフォルト: ALT)
select_modifier=
# ホットバー表示切替キーを設定する(デフォルト: (なし) [無効])
toggle_hotbar=SPACE
```

menuconf.tab 設定方法
---------------------
従来通り、`(インストールフォルダー)/(pakセット)/config/menuconf.tab` を書き換えることで、キーボードショートカットを指定できます。本パッチでは、修飾キーの指定はスペースで区切り、アルファベットのキーの指定は大文字で行ってください。例: `ALT SHIFT K`。

`menuconf.tab` で指定できる修飾キー
- `SHIFT`
- `CTRL`
- `ALT`
- `SUPER` (Windowsキーのことです)
- `CONTEXT` (アプリケーションキー(通常押すと右クリックメニューがでてくる) のことです）

**注意事項**
- OSが反応するキーは割り当てても使えません。例: `ALT F4` (特に、SUPER キーの割り当ては、ほとんどOSが反応してしまうと思います。)
- ホットバーのキー設定とかち合った場合ホットバーが優先されます。
- 数字キーがホットバーに指定されていない場合、修飾なしの数字キーは画面のスクロールが優先されます。

ビルド方法
==========
Windows (GDI バックエンド) のみビルドできます。

配布バイナリはMinGW 64bit環境でビルドしました。
通常のOTRP版と同様に、`autoupdate && autoconf && ./configure && make` でビルドします。

Linux / Mac OS 版をビルドしたい場合は、キーボードまわりのコード(`sys/simsys_S2.cc`) を多少加筆する必要があります。
ソースコードのインデントが変なときは tabstop=2 を設定してください。

注意点
======
- キー名がASCII文字でないキー(通常の日本語キーボード配列には有りません) は、いまは`menuconf.tab`でショートカットとして指定できなくなっています。
- 日本語入力モードがONの状態からでも問題なくキーを認識します。
- Windowsのキーボード配列の変更機能(Windowsキー + スペースでUS配列などと切り替えられる機能)を利用している場合、切り替え中に認識するキーの種類は変更後のものになります。

[^1]: 一般選択ツール(キーボードショートカットのS, T, E)で選択したツールはうまく登録できません。（アイコンが表示されません。)
[^2]: ホットバーから再起動した場合は、ツールバーや他のスロットにある同じスクリプトツールの状態はリセットされません。
[^3]: CTRLにより再起動を行うと、新しく再起動した状態が作られ、再起動を行ったツールバーもしくはホットバーのスロットに割り当てられます。
[^4]: どのツールバー、どのホットバースロットにも割り当てられていない状態ができたとき、その状態は終了処理がおこなわれます。
